##' This function can be used to create a hexagonal sticker following
##' the guidelines described in the BioC-sticker sticker
##' repository. The function requires the following packages: ggplot2,
##' ggforce, ggtree, showtext and grid, if lattice objects are used.
##'
##' @title Create a BioC sticker.
##' @param x The package logo. Can either be a ggplot, lattice or grob
##'     object.
##' @param package Package name, to be used as label on the
##'     sticker. Default is \code{"Bioconductor"}.
##' @param text_size Label font size. Default is 22.
##' @param col_text Label font colour. Default is \code{"#FFFFFF"}.
##' @param col_background Background colour. Default is
##'     \code{"#1881C2"}.
##' @param col_border Border colour. Default is \code{"#87B13F"}.
##' @param grob_xmin Left position of the image. Default is 0.
##' @param grob_xmax Right position of the image. Default is 2.
##' @param grob_ymin Bottom position of the image. Default is 0.05.
##' @param grob_ymax Top position of the image. Default is 1.75.
##' @param font Font for the package name. Default is
##'     \code{"Aller_Rg"}. Fonts shipped with the package are
##'     available in \code{available_fonts} and any uniquely matching
##'     subset can be used. For custom fonts, see
##'     \code{font_custom}. This parameter is ignored if a custom font
##'     is provided.
##' @param font_custom A \code{character} defined the ful path to a
##'     local font.
##' @param text_x Text horizontal alignment. Default is 1.
##' @param text_y Text vertical alignment. Default is 1.44.
##' @param filename By default, the sticker is saved saved printed to
##'     a png file named after the \code{package} name. If you prefer
##'     not to create any file, set to \code{NULL}.
##' @return Invisibly returns the \code{ggplot} sticker
##'     object. Creates a png file as side effect, unless
##'     \code{filename} is \code{NULL}.
##' @author Laurent Gatto and Guangchuang Yu
##' @examples
##' stkr <- make_sticker(package = "Bioconductor",
##'                      filename = NULL)
##' print(stkr)
##' library("ggplot2")
##' p <- ggplot(aes(x = mpg, y = wt), data = mtcars) + geom_point()
##' x <- make_sticker(p, "Bioconductor", filename = NULL,
##'                   grob_xmin = 0.5, grob_xmax = 1.5,
##'                   grob_ymin = .35, grob_ymax = 1.25)
##' x
make_sticker <- function(x,
                         package = "Bioconductor",
                         text_size = 6,
                         col_text = "#FFFFFF",
                         col_background = "#1881C2",
                         col_border = "#87B13F",
                         grob_xmin = 0,
                         grob_xmax = 1.65,
                         grob_ymin = 0.25,
                         grob_ymax = 1.3,
                         font = "Aller_Rg",
                         font_custom,
                         text_x = 1,
                         text_y = 1.4,
                         filename = paste(package, "png", sep = ".")) {
    if (!missing(font_custom)) {
        stopifnot(file.exists(font_custom))
        fnt <- font_custom
    } else {
        fnt <- grep(font, available_fonts(), value = TRUE, fixed = TRUE)
        if (length(fnt) != 1) {
            cat("Available fonts: ",
                strwrap(paste(available_fonts(), collapse = ", ")),
                sep = "\n ")
            stop("Font ", font, " is not available.", call. = FALSE)
        }
    }
    font.add("Aller", fnt)
    showtext.auto()

    x0 <- y0 <- r <- NULL ## Undefined global functions or variables
    d <- data.frame(x0 = 1, y0 = 1, r = 1)
    hex <- ggplot() +
        geom_circle(aes(x0 = x0, y0 = y0, r = r),
                    size = 1.2, data = d, n = 5.5,
                    fill = col_background, color = col_border) +
        coord_fixed()
    sticker <- hex + theme_transparent() +
        theme(strip.text = element_blank()) +
        theme(line = element_blank(),
              text = element_blank(),
              title = element_blank())

    if (!missing(x)) {
        if (inherits(x, "ggplot"))
            x <- ggplotGrob(x)
        if (inherits(x, "lattice")) {
            requireNamespace("grid")
            x <- grid::grid.grabExpr(x)
        }
        stopifnot(inherits(x, "grob"))
        sticker <- sticker +
            annotation_custom(x,
                              xmin = grob_xmin, xmax = grob_xmax,
                              ymin = grob_ymin, ymax = grob_ymax)
    }

    sticker <- sticker +
        annotate('text', x = text_x, y = text_y, label = package,
                 family = 'Aller', size = text_size, color = col_text) +
        scale_y_continuous(expand = c(0, 0), limits = c(-0.018, 2.018)) +
        scale_x_continuous(expand = c(0, 0), limits = c(.12, 1.898)) +
        theme(plot.margin = unit(c(0, 0, 0, 0), "lines"))

    if (!is.null(filename))
        ggsave(sticker, width = 43.942, height = 50.62,
               filename = filename,
               bg = 'transparent',
               units = "mm")
    invisible(sticker)
}
